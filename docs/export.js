import{db}from"./db.js";function toCSV(t,e,n={}){let i=[e.join(","),...t.map(t=>e.map(e=>`"${(t[e]??"").toString().replace(/"/g,'""')}"`).join(","))].join("\r\n");return n.footer&&(i+=`\r\n${n.footer}`),n.title&&(i=`${n.title}\r\n${i}`),i}function facilityMeta(){const t=db.facility||{};return[`Facility: ${t.name||""}`,`Region: ${t.region||""}`,`District: ${t.district||""}`,`Community: ${t.community||""}`,`Contact: ${t.contact||""}`,`Generated: ${(new Date).toLocaleString()}`].filter(Boolean).join(" | ")}function downloadFile(t,e,n="text/csv"){t.endsWith(".html")||t.endsWith(".htm")||(e=btoa(unescape(encodeURIComponent(e))),n="application/json");const i=new Blob([e],{type:n}),o=URL.createObjectURL(i),r=document.createElement("a");r.href=o,r.download=t,document.body.appendChild(r),r.click(),setTimeout(()=>{document.body.removeChild(r),URL.revokeObjectURL(o)},100)}export function exportPatients(){downloadFile("patients_line_list.csv",toCSV(db.patients||[],["patientID","name","dob","age","sex","phone","address","idType","idNumber","registrationDate"],{title:`PATIENTS LINE LIST - ${db.facility?.name||""}`,footer:facilityMeta()}))}export function exportVisits(){downloadFile("visits_line_list.csv",toCSV(db.visits||[],["visitID","patientID","date","service","provider","notes"],{title:`VISITS LINE LIST - ${db.facility?.name||""}`,footer:facilityMeta()}))}export function exportServiceDelivery(){downloadFile("service_delivery_list.csv",toCSV(db.services||[],["serviceID","patientID","service","date","provider","outcome"],{title:`SERVICE DELIVERY LIST - ${db.facility?.name||""}`,footer:facilityMeta()}))}export function exportRegisters(){downloadFile("registers_list.csv",toCSV(db.registers||[],["registerID","name","status","created","lastUsed"],{title:`REGISTERS LIST - ${db.facility?.name||""}`,footer:facilityMeta()}))}export function exportSummaryReport(){const t=db.facility||{};downloadFile("summary_report.txt",[`SUMMARY REPORT - ${t.name||""}`,`Region: ${t.region||""} | District: ${t.district||""} | Community: ${t.community||""}`,`Contact: ${t.contact||""}`,"----------------------------------------",`Total Patients: ${(db.patients||[]).length}`,`Total Visits: ${(db.visits||[]).length}`,`Total Services: ${(db.services||[]).length}`,`Active Registers: ${(db.registers||[]).filter(t=>"active"===t.status).length}`,`Inactive Registers: ${(db.registers||[]).filter(t=>"inactive"===t.status).length}`,`Report Date: ${(new Date).toLocaleString()}`].join("\n"),"text/plain")}export function exportPatientA4(t){const e=db.facility||{},n=(db.patients||[]).find(e=>e.patientID===t);if(!n)return alert("Patient not found!");const i=(db.visits||[]).filter(e=>e.patientID===t),o=(db.services||[]).filter(e=>e.patientID===t),r=`\n    <html>\n    <head>\n      <title>Patient Report - ${n.name}</title>\n      <style>\n        body { font-family: Arial, sans-serif; margin: 40px; }\n        h2 { border-bottom: 1px solid #333; }\n        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }\n        th, td { border: 1px solid #999; padding: 6px 8px; }\n        th { background: #eee; }\n        .facility-header { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; }\n        .facility-meta { font-size: 0.95em; color: #555; margin-bottom: 20px; }\n        .footer { margin-top:40px;font-size:12px;color:#888; }\n        .logo { max-height: 60px; margin-bottom: 10px; }\n      </style>\n    </head>\n    <body>\n      ${e.image?`<img src="${e.image}" class="logo"><br>`:""}\n      <div class="facility-header">${e.name||""}</div>\n      <div class="facility-meta">\n        ${[e.region&&`Region: ${e.region}`,e.district&&`District: ${e.district}`,e.community&&`Community: ${e.community}`,e.contact&&`Contact: ${e.contact}`].filter(Boolean).join(" | ")}\n      </div>\n      <h2>Patient Report</h2>\n      <table>\n        <tr><th>ID</th><td>${n.patientID}</td></tr>\n        <tr><th>Name</th><td>${n.name}</td></tr>\n        <tr><th>Date of Birth</th><td>${n.dob||""}</td></tr>\n        <tr><th>Age</th><td>${n.age||""}</td></tr>\n        <tr><th>Sex</th><td>${n.sex||""}</td></tr>\n        <tr><th>Phone</th><td>${n.phone||""}</td></tr>\n        <tr><th>Address</th><td>${n.address||""}</td></tr>\n        <tr><th>ID Type</th><td>${n.idType||""}</td></tr>\n        <tr><th>ID Number</th><td>${n.idNumber||""}</td></tr>\n        <tr><th>Registration Date</th><td>${n.registrationDate||""}</td></tr>\n      </table>\n      <h3>Visits</h3>\n      <table>\n        <tr><th>Date</th><th>Service</th><th>Provider</th><th>Notes</th></tr>\n        ${i.map(t=>`<tr>\n          <td>${t.date||""}</td>\n          <td>${t.service||""}</td>\n          <td>${t.provider||""}</td>\n          <td>${t.notes||""}</td>\n        </tr>`).join("")}\n      </table>\n      <h3>Services Delivered</h3>\n      <table>\n        <tr><th>Date</th><th>Service</th><th>Provider</th><th>Outcome</th></tr>\n        ${o.map(t=>`<tr>\n          <td>${t.date||""}</td>\n          <td>${t.service||""}</td>\n          <td>${t.provider||""}</td>\n          <td>${t.outcome||""}</td>\n        </tr>`).join("")}\n      </table>\n      <footer class="footer">\n        ${facilityMeta()}<br>\n        Generated: ${(new Date).toLocaleString()}\n      </footer>\n    </body>\n    </html>\n  `,a=window.open("","_blank");a.document.write(r),a.document.close(),a.print()}export function encryptData(t){return btoa(unescape(encodeURIComponent(t)))}export function decryptData(t){try{return decodeURIComponent(escape(atob(t)))}catch{return t}}