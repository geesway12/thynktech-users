import{db,saveDb}from"./db.js";function getServicesList(){const e=db.currentUser;return e&&Array.isArray(e.assignedRegisters)&&e.assignedRegisters.length?e.assignedRegisters:[]}export function renderVisitLog(e){db.facility||(db.facility={}),db.patients||(db.patients=[]),db.visits||(db.visits=[]);const t=getServicesList(),i=db.visits||[];e.innerHTML=`\n    <div class="container my-4">\n      <div class="d-flex align-items-center justify-content-between">\n        <h4><i class="bi bi-journal-text"></i> Log Visit</h4>\n      </div>\n      <form id="visitForm" class="row g-2 mb-3">\n        <div class="col-md-3"><input type="text" class="form-control" id="searchPat" placeholder="Search Patient by ID or Name" required></div>\n        <div class="col-md-3"><input type="date" class="form-control" id="visitDate" max="${(new Date).toISOString().slice(0,10)}" value="${(new Date).toISOString().slice(0,10)}"></div>\n        <div class="col-md-4">\n          <select class="form-select" id="serviceType" multiple required size="4">\n            ${t.length?t.map(e=>`<option value="${e}">${e}</option>`).join(""):"<option disabled>No assigned services</option>"}\n          </select>\n        </div>\n        <div class="col-md-2"><button class="btn btn-primary w-100"><i class="bi bi-check-lg"></i> Log Visit</button></div>\n      </form>\n      <div id="foundPatient"></div>\n      <div id="visitMsg"></div>\n      <div class="mt-4">\n        <h5>Visits Logged</h5>\n        <div class="card shadow-sm">\n          <div class="card-body p-2">\n            <table class="table table-bordered table-sm mb-0 visit-table-mobile">\n              <thead>\n                <tr>\n                  <th>Date</th>\n                  <th>Patient</th>\n                  <th>Service(s)</th>\n                  <th>Provider</th>\n                  <th>Notes</th>\n                </tr>\n              </thead>\n              <tbody>\n                ${i.length?i.map(e=>`\n                  <tr>\n                    <td data-label="Date">${e.visitDate||""}</td>\n                    <td data-label="Patient">${e.patientID||""}</td>\n                    <td data-label="Service(s)">${Array.isArray(e.serviceType)?e.serviceType.join(", "):e.serviceType||""}</td>\n                    <td data-label="Provider">${e.loggedBy||""}</td>\n                    <td data-label="Notes">${e.notes||""}</td>\n                  </tr>\n                `).join(""):'<tr><td colspan="5" class="text-center text-muted">No visits logged yet.</td></tr>'}\n              </tbody>\n            </table>\n          </div>\n        </div>\n      </div>\n      <a href="#user-dashboard" class="btn btn-link mt-2"><i class="bi bi-arrow-left"></i> Back to Dashboard</a>\n    </div>\n  `;let s=null;e.querySelector("#searchPat").oninput=function(){const t=this.value.trim().toLowerCase();s=db.patients.find(e=>e.patientID?.toLowerCase()===t||e.name?.toLowerCase()===t);const i=e.querySelector("#foundPatient");s?i.innerHTML=`<div class="alert alert-success">Found: <b>${s.name}</b> [${s.patientID}]</div>`:t.length>2?i.innerHTML='<div class="alert alert-warning">No patient found!</div>':i.innerHTML=""},e.querySelector("#visitForm").onsubmit=function(t){if(t.preventDefault(),!s)return void(e.querySelector("#visitMsg").innerHTML='<div class="alert alert-danger">Select a valid patient first.</div>');const i=Array.from(this.serviceType.selectedOptions).map(e=>e.value);if(!i.length)return void(e.querySelector("#visitMsg").innerHTML='<div class="alert alert-danger">Select at least one service.</div>');const n={patientID:s.patientID,visitDate:this.visitDate.value,serviceType:i,facility:db.facility?.name||"",loggedBy:db.currentUser?.username||"",timestamp:Date.now()};db.visits.push(n),saveDb(),e.querySelector("#visitMsg").innerHTML='<div class="alert alert-success">Visit logged!</div>',this.reset(),e.querySelector("#foundPatient").innerHTML="",s=null,renderVisitLog(e)}}export function createVisitForm(e,t){const i=document.createElement("div");i.className="visit-form my-3",db.facility||(db.facility={}),db.patients||(db.patients=[]),db.visits||(db.visits=[]);const s=getServicesList();i.innerHTML=`\n    <form class="row g-2">\n      <div class="col-md-4">\n        <select class="form-select" multiple required size="4">\n          ${s.length?s.map(e=>`<option value="${e}">${e}</option>`).join(""):"<option disabled>No assigned services</option>"}\n        </select>\n      </div>\n      <div class="col-md-3">\n        <input type="date" class="form-control" max="${(new Date).toISOString().slice(0,10)}" value="${(new Date).toISOString().slice(0,10)}">\n      </div>\n      <div class="col-md-2">\n        <button class="btn btn-success w-100" type="submit"><i class="bi bi-check2-circle"></i> Save</button>\n      </div>\n    </form>\n    <div class="visit-msg mt-2"></div>\n  `;const n=i.querySelector("form");return n.onsubmit=function(s){s.preventDefault();const a=Array.from(n.querySelector("select").selectedOptions).map(e=>e.value),r=n.querySelector("input").value;if(!a.length)return void(i.querySelector(".visit-msg").innerHTML='<div class="alert alert-danger">Select a service</div>');const l={patientID:e.patientID,visitDate:r,serviceType:a,facility:db.facility?.name||"",loggedBy:db.currentUser?.username||"",timestamp:Date.now()};db.visits.push(l),saveDb(),i.querySelector(".visit-msg").innerHTML='<div class="alert alert-success">Visit logged!</div>',t&&t()},i}