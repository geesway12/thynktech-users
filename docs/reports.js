import{db}from"./db.js";function loadChartJs(e){if(window.Chart)return e();const t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/chart.js",t.onload=e,document.head.appendChild(t)}export function renderReports(e){const t=(new Date).getFullYear();let n=t;function s(e,t,n){return e.filter(e=>{const s=new Date(e[t]);return s>=n.start&&s<=n.end})}function a(e){let t=new Date(n,0,1),a=new Date(n,11,31);const i=document.getElementById("quarterSelect").value,o=document.getElementById("monthSelect").value,r=document.getElementById("weekSelect").value;if(i&&(t=new Date(n,3*(i-1),1),a=new Date(n,3*(i-1)+2+1,0)),o&&(t=new Date(n,o-1,1),a=new Date(n,o,0)),o&&r){const e=new Date(n,o-1,1),s=parseInt(r,10),i=new Date(e);i.setDate(1+7*(s-1));const l=new Date(i);l.setDate(i.getDate()+6),i.getMonth()===e.getMonth()&&(t=i),a=l.getMonth()===e.getMonth()?l:new Date(n,o,0)}a.setHours(23,59,59,999);const l={start:t,end:a},d=document.getElementById("weekSelect");if(o){const e=new Date(n,o-1,1),t=new Date(n,o,0),s=Math.ceil((t.getDate()+e.getDay())/7);d.innerHTML='<option value="">Week</option>'+Array.from({length:s},(e,t)=>`<option value="${t+1}">Week ${t+1}</option>`).join("")}else d.innerHTML='<option value="">Week</option>';const c=s(db.patients,"registrationDate",l),p=s(db.visits,"visitDate",l),v=s(db.appointments,"appointmentDate",l);document.getElementById("reportContent").innerHTML=`\n      <div class="row g-3">\n        <div class="col-md-3">\n          <div class="card shadow-sm text-center">\n            <div class="card-body">\n              <i class="bi bi-people fs-1 text-primary"></i>\n              <h6>Total Patients</h6>\n              <p class="fs-5" id="patientCount">${c.length}</p>\n            </div>\n          </div>\n        </div>\n        <div class="col-md-3">\n          <div class="card shadow-sm text-center">\n            <div class="card-body">\n              <i class="bi bi-calendar-check fs-1 text-success"></i>\n              <h6>Total Visits</h6>\n              <p class="fs-5" id="visitCount">${p.length}</p>\n            </div>\n          </div>\n        </div>\n        <div class="col-md-3">\n          <div class="card shadow-sm text-center">\n            <div class="card-body">\n              <i class="bi bi-briefcase fs-1 text-warning"></i>\n              <h6>Services Delivered</h6>\n              <p class="fs-5" id="serviceCount">${p.reduce((e,t)=>e+(t.serviceType?.length||0),0)}</p>\n            </div>\n          </div>\n        </div>\n        <div class="col-md-3">\n          <div class="card shadow-sm text-center">\n            <div class="card-body">\n              <i class="bi bi-clock-history fs-1 text-danger"></i>\n              <h6>Total Appointments</h6>\n              <p class="fs-5" id="appointmentCount">${v.length}</p>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class="row g-3 mt-3">\n        <div class="col-md-4">\n          <div class="card shadow-sm">\n            <div class="card-body">\n              <h6>Patients by Sex</h6>\n              <canvas id="sexPie" height="220"></canvas>\n            </div>\n          </div>\n        </div>\n        <div class="col-md-4">\n          <div class="card shadow-sm">\n            <div class="card-body">\n              <h6>Services Delivered</h6>\n              <canvas id="serviceBar" height="220"></canvas>\n            </div>\n          </div>\n        </div>\n        <div class="col-md-4">\n          <div class="card shadow-sm">\n            <div class="card-body">\n              <h6>Visits Trend</h6>\n              <canvas id="visitTrend" height="220"></canvas>\n            </div>\n          </div>\n        </div>\n      </div>\n      <a href="#user-dashboard" class="btn btn-link mt-3"><i class="bi bi-arrow-left"></i> Back</a>\n    `,loadChartJs(()=>{const e=c.filter(e=>"M"===(e.sex||"").toString().trim().toUpperCase()||"MALE"===(e.sex||"").toString().trim().toUpperCase()).length,t=c.filter(e=>"F"===(e.sex||"").toString().trim().toUpperCase()||"FEMALE"===(e.sex||"").toString().trim().toUpperCase()).length,n=c.filter(e=>{const t=(e.sex||"").toString().trim().toUpperCase();return t&&"M"!==t&&"MALE"!==t&&"F"!==t&&"FEMALE"!==t}).length,s=[],a=[];e>0&&(s.push("Male"),a.push(e)),t>0&&(s.push("Female"),a.push(t)),n>0&&(s.push("Other"),a.push(n)),new Chart(document.getElementById("sexPie"),{type:"pie",data:{labels:s,datasets:[{data:a,backgroundColor:["#0d6efd","#e83e8c","#6c757d"].slice(0,s.length)}]},options:{responsive:!0,plugins:{legend:{display:!1}}}});const i={};p.forEach(e=>{Array.isArray(e.serviceType)?e.serviceType.forEach(e=>{i[e]=(i[e]||0)+1}):e.serviceType&&(i[e.serviceType]=(i[e.serviceType]||0)+1)});const o=Object.keys(i),r=o.map(e=>i[e]);new Chart(document.getElementById("serviceBar"),{type:"bar",data:{labels:o,datasets:[{data:r,backgroundColor:"#0d6efd"}]},options:{responsive:!0,plugins:{legend:{display:!1}},indexAxis:"y",scales:{x:{beginAtZero:!0}}}});const d=[];let v=new Date(l.start);for(;v<=l.end;)d.push(v.toISOString().slice(0,10)),v.setDate(v.getDate()+1);const g=d.map(e=>p.filter(t=>(t.visitDate||"").slice(0,10)===e).length);new Chart(document.getElementById("visitTrend"),{type:"line",data:{labels:d,datasets:[{label:"Visits",data:g,borderColor:"#198754",backgroundColor:"rgba(25,135,84,0.2)",fill:!0}]},options:{responsive:!0,plugins:{legend:{display:!1}}}})})}e.innerHTML=`\n    <div class="container my-4">\n      <div class="d-flex justify-content-between align-items-center mb-3">\n        <h4><i class="bi bi-bar-chart"></i> Reports</h4>\n        <div class="d-flex align-items-center gap-2">\n          <select id="yearSelect" class="form-select w-auto">\n            ${Array.from({length:6},(e,n)=>t-n).map(e=>`<option value="${e}"${e===t?" selected":""}>${e}</option>`).join("")}\n          </select>\n          <select id="quarterSelect" class="form-select w-auto">\n            <option value="">Quarter</option>\n            <option value="1">Q1</option>\n            <option value="2">Q2</option>\n            <option value="3">Q3</option>\n            <option value="4">Q4</option>\n          </select>\n          <select id="monthSelect" class="form-select w-auto">\n            <option value="">Month</option>\n            ${Array.from({length:12},(e,t)=>`<option value="${t+1}">${new Date(2e3,t,1).toLocaleString("default",{month:"long"})}</option>`).join("")}\n          </select>\n          <select id="weekSelect" class="form-select w-auto">\n            <option value="">Week</option>\n          </select>\n        </div>\n      </div>\n      <div id="reportContent"></div>\n    </div>\n  `,document.getElementById("yearSelect").onchange=e=>{n=+e.target.value,a()},document.getElementById("quarterSelect").onchange=()=>{document.getElementById("monthSelect").value="",document.getElementById("weekSelect").innerHTML='<option value="">Week</option>',a()},document.getElementById("monthSelect").onchange=()=>{document.getElementById("quarterSelect").value="",a()},document.getElementById("weekSelect").onchange=()=>{a()},a();const i=db.registers.map(e=>({register:e.name,services:db.visits.filter(t=>t.registerId===e.id).reduce((e,t)=>e+(t.serviceType?.length||0),0)})),o=db.appointments.reduce((e,t)=>(e[t.status]=(e[t.status]||0)+1,e),{});console.log("Services per Register:",i),console.log("Appointments by Status:",o),loadChartJs(()=>{const e=db.patients.filter(e=>"M"===(e.sex||"").toString().trim().toUpperCase()||"MALE"===(e.sex||"").toString().trim().toUpperCase()).length,t=db.patients.filter(e=>"F"===(e.sex||"").toString().trim().toUpperCase()||"FEMALE"===(e.sex||"").toString().trim().toUpperCase()).length,n=db.patients.filter(e=>{const t=(e.sex||"").toString().trim().toUpperCase();return t&&"M"!==t&&"MALE"!==t&&"F"!==t&&"FEMALE"!==t}).length,s=[],a=[];e>0&&(s.push("Male"),a.push(e)),t>0&&(s.push("Female"),a.push(t)),n>0&&(s.push("Other"),a.push(n)),new Chart(document.getElementById("sexPie"),{type:"pie",data:{labels:s,datasets:[{data:a,backgroundColor:["#0d6efd","#e83e8c","#6c757d"].slice(0,s.length)}]},options:{responsive:!0,plugins:{legend:{display:!1}}}});const i={};(db.visits||[]).forEach(e=>{Array.isArray(e.serviceType)?e.serviceType.forEach(e=>{i[e]=(i[e]||0)+1}):e.serviceType&&(i[e.serviceType]=(i[e.serviceType]||0)+1)});const o=Object.keys(i),r=o.map(e=>i[e]);new Chart(document.getElementById("serviceBar"),{type:"bar",data:{labels:o,datasets:[{data:r,backgroundColor:"#0d6efd"}]},options:{responsive:!0,plugins:{legend:{display:!1}},indexAxis:"y",scales:{x:{beginAtZero:!0}}}});const l=[],d=new Date;for(let e=11;e>=0;e--){const t=new Date(d.getFullYear(),d.getMonth()-e,1);l.push(`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`)}const c=l.map(e=>db.visits.filter(t=>(t.visitDate||"").slice(0,7)===e).length);new Chart(document.getElementById("visitTrend"),{type:"line",data:{labels:l,datasets:[{label:"Visits",data:c,borderColor:"#198754",backgroundColor:"rgba(25,135,84,0.2)",fill:!0}]},options:{responsive:!0,plugins:{legend:{display:!1}}}})})}