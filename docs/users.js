import{db,saveDb}from"./db.js";import{renderServiceVisitSelector}from"./services.js";import{encryptData,decryptData}from"./export.js";export function renderUserDashboard(e){const i=db.currentUser;if(!i)return void(window.location.hash="#login");const t=Array.isArray(i.assignedRegisters)?i.assignedRegisters:[],s=((db.registers||[]).filter(e=>t.includes(e.name)),db.facility||{}),n=`\n    <div class="facility-meta mb-3">\n      ${s.image?`<img src="${s.image}" alt="Facility Logo" style="max-height:60px; margin-bottom:8px;"><br>`:""}\n      <span class="fw-bold">${s.name||""}</span>\n      <div class="text-muted small">\n        ${[s.region&&`Region: ${s.region}`,s.district&&`District: ${s.district}`,s.community&&`Community: ${s.community}`,s.contact&&`Contact: ${s.contact}`].filter(Boolean).join(" | ")}\n      </div>\n    </div>\n  `;e.innerHTML=`\n  <style>\n    @media (min-width: 768px) {\n      .dashboard-row-equal {\n        display: flex;\n        flex-wrap: wrap;\n      }\n      .dashboard-row-equal > [class^='col-'] {\n        display: flex;\n        flex-direction: column;\n      }\n      .dashboard-row-equal .card {\n        flex: 1 1 auto;\n        height: 100%;\n        min-height: 350px;\n      }\n    }\n    @media (max-width: 767.98px) {\n      .dashboard-row-equal .card {\n        min-height: unset;\n      }\n    }\n  </style>\n  <div class="container my-4">\n    ${n}\n    <div class="row mt-4 g-3 dashboard-row-equal">\n      <div class="col-12 col-md-6 d-flex">\n        <div class="card shadow mb-4 flex-fill">\n          <div class="card-body d-flex flex-column">\n            <h5><i class="bi bi-person"></i> Quick Actions</h5>\n            <div class="list-group mb-3 flex-grow-1">\n              ${i.canPatientReg?'<a href="#patient-reg" class="list-group-item list-group-item-action"><i class="bi bi-person-plus me-2"></i>Patient Registration</a>':""}\n              ${i.canVisitLog?'<a href="#visit-log" class="list-group-item list-group-item-action"><i class="bi bi-journal-medical me-2"></i>Visit Logging</a>':""}\n              <a href="#appointments" class="list-group-item list-group-item-action" id="appointmentsLink"><i class="bi bi-calendar-event me-2"></i>Appointments</a>\n              <a href="#reports" class="list-group-item list-group-item-action"><i class="bi bi-bar-chart me-2"></i>Reports</a>\n              <a href="#export-backup" class="list-group-item list-group-item-action"><i class="bi bi-cloud-arrow-down me-2"></i>Export/Backup</a>\n            </div>\n            <div class="mt-auto text-end">\n              <a href="#profile" id="userProfileLink" class="btn btn-outline-secondary"><i class="bi bi-person-gear"></i> Profile</a>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class="col-12 col-md-6 d-flex">\n        <div class="card shadow mb-4 flex-fill">\n          <div class="card-body d-flex flex-column">\n            <h5><i class="bi bi-calendar-check"></i> Upcoming Appointments Today</h5>\n            <div id="upcomingAppointments" class="mb-3 flex-grow-1"></div>\n            <div id="shareModal" class="modal"></div>\n            <div id="shareMsg" class="small mt-2 text-muted"></div>\n            <div class="text-end mt-3">\n              <button class="btn btn-outline-secondary" id="logoutBtn"><i class="bi bi-box-arrow-right"></i> Logout</button>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n  `;const a=e.querySelector("#upcomingAppointments");if(a){const e=new Date,i=new Date(e);i.setDate(e.getDate()+7);const t=(db.appointments||[]).filter(e=>e.appointmentDate).map(e=>({...e,due:new Date(e.appointmentDate)})).filter(t=>!isNaN(t.due)&&t.due>=new Date(e.toDateString())&&t.due<=i).sort((e,i)=>e.due-i.due).slice(0,5);0===t.length?a.innerHTML='<div class="text-muted small">No upcoming appointments for this week.</div>':a.innerHTML='<ul class="list-group">'+t.map(i=>{const t=(db.patients||[]).find(e=>e.patientID===i.patientID),s=Math.ceil((i.due-e)/864e5);let n="";s<0?n='<span class="badge bg-danger ms-2">Overdue</span>':0===s?n='<span class="badge bg-warning text-dark ms-2">Today</span>':s<=3&&(n=`<span class="badge bg-info text-dark ms-2">${s} day${s>1?"s":""}</span>`);let a="";if(i.status){a=`<span class="badge bg-${"Completed"===i.status?"success":"Scheduled"===i.status?"primary":"secondary"} ms-2">${i.status}</span>`}return`<li class="list-group-item d-flex flex-column">\n            <span><i class="bi bi-person-circle me-2"></i>${t?t.name:i.patientID}</span>\n            <span class="small text-muted"><i class="bi bi-activity"></i> ${i.serviceType||"-"}</span>\n            <span class="small"><i class="bi bi-clock"></i> ${i.appointmentDate} ${n} ${a}</span>\n          </li>`}).join("")+"</ul>"}import("./profile.js").then(t=>{const{renderProfile:s,isPasswordExpired:n}=t;n(i)&&setTimeout(()=>{alert("Your password has expired. Please update your password now."),s(e)},500),setTimeout(()=>{const i=document.getElementById("userProfileLink");i&&(i.onclick=i=>{i.preventDefault(),s(e)})},100)}),e.querySelector("#logoutBtn").onclick=()=>{db.currentUser=null,saveDb(),window.location.hash="#login"};const r=e.querySelector('a[href="#export-backup"]');r&&(r.onclick=i=>{i.preventDefault(),function(e){db.currentUser;const i=db.facility||{},t=`\n    <div class="facility-meta mb-3">\n      ${i.image?`<img src="${i.image}" alt="Facility Logo" style="max-height:60px; margin-bottom:8px;"><br>`:""}\n      <span class="fw-bold">${i.name||""}</span>\n      <div class="text-muted small">\n        ${[i.region&&`Region: ${i.region}`,i.district&&`District: ${i.district}`,i.community&&`Community: ${i.community}`,i.contact&&`Contact: ${i.contact}`].filter(Boolean).join(" | ")}\n      </div>\n    </div>\n  `;e.innerHTML=`\n    <style>\n      @media (min-width: 768px) {\n        .dashboard-row-equal {\n          display: flex;\n          flex-wrap: wrap;\n        }\n        .dashboard-row-equal > [class^='col-'] {\n          display: flex;\n          flex-direction: column;\n        }\n        .dashboard-row-equal .card {\n          flex: 1 1 auto;\n          height: 100%;\n          min-height: 350px;\n        }\n      }\n      @media (max-width: 767.98px) {\n        .dashboard-row-equal .card {\n          min-height: unset;\n        }\n      }\n    </style>\n    <div class="container my-4">\n      ${t}\n      <div class="row mt-4 g-3 dashboard-row-equal">\n        <div class="col-12 col-md-6 d-flex">\n          <div class="card shadow mb-4 flex-fill">\n            <div class="card-body d-flex flex-column">\n              <h5><i class="bi bi-cloud-arrow-down"></i> Export Data</h5>\n              <div class="list-group mb-3 flex-grow-1">\n                <button class="list-group-item list-group-item-action" id="exportPatients"><i class="bi bi-people me-2"></i> Export Patients</button>\n                <button class="list-group-item list-group-item-action" id="exportVisits"><i class="bi bi-journal-medical me-2"></i> Export Visits</button>\n                <button class="list-group-item list-group-item-action" id="exportServices"><i class="bi bi-ui-checks-grid me-2"></i> Export Services</button>\n                <button class="list-group-item list-group-item-action" id="exportSingle"><i class="bi bi-file-earmark-pdf me-2"></i> Single Patient (PDF)</button>\n              </div>\n              <div class="mt-auto text-end">\n                <button class="btn btn-primary" id="backToDashboardBtn"><i class="bi bi-arrow-left"></i> Back to Dashboard</button>\n              </div>\n            </div>\n          </div>\n        </div>\n        <div class="col-12 col-md-6 d-flex">\n          <div class="card shadow mb-4 flex-fill">\n            <div class="card-body d-flex flex-column">\n              <h5><i class="bi bi-upload"></i> Import Data</h5>\n              <div class="list-group mb-3 flex-grow-1">\n                <label class="list-group-item list-group-item-action" style="cursor:pointer;">\n                  <i class="bi bi-upload me-2"></i> Import Patients\n                  <input type="file" id="importPatients" hidden>\n                </label>\n                <label class="list-group-item list-group-item-action" style="cursor:pointer;">\n                  <i class="bi bi-upload me-2"></i> Import Visits\n                  <input type="file" id="importVisits" hidden>\n                </label>\n                <label class="list-group-item list-group-item-action" style="cursor:pointer;">\n                  <i class="bi bi-upload me-2"></i> Import Services\n                  <input type="file" id="importServices" hidden>\n                </label>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  `,document.getElementById("exportPatients").onclick=()=>exportPatients(),document.getElementById("exportVisits").onclick=()=>exportVisits(),document.getElementById("exportServices").onclick=()=>exportServiceDelivery(),document.getElementById("exportSingle").onclick=()=>{const e=prompt("Enter Patient ID to export:");e&&exportPatientA4(e.trim())},document.getElementById("importPatients").onchange=e=>importPatients(e.target.files[0]),document.getElementById("importVisits").onchange=e=>importVisits(e.target.files[0]),document.getElementById("importServices").onchange=e=>importServices(e.target.files[0]),document.getElementById("backToDashboardBtn").onclick=()=>renderUserDashboard(e)}(e)});const o=e.querySelector("#importSharedFile");o&&o.addEventListener("change",i=>{const t=i.target.files[0];if(!t)return;const s=new FileReader;s.onload=function(i){try{let t;try{t=JSON.parse(decryptData(i.target.result))}catch{t=JSON.parse(i.target.result)}let s={patients:0,visits:0,services:0,registers:0};t.patients?.forEach(e=>{db.patients.some(i=>i.id&&e.id&&i.id===e.id||i.patientID&&e.patientID&&i.patientID===e.patientID)||(db.patients.push(e),s.patients++)}),t.visits?.forEach(e=>{db.visits.some(i=>i.id&&e.id&&i.id===e.id||i.visitID&&e.visitID&&i.visitID===e.visitID)||(db.visits.push(e),s.visits++)}),t.services?.forEach(e=>{db.services.some(i=>i.id&&e.id&&i.id===e.id||i.serviceID&&e.serviceID&&i.serviceID===e.serviceID)||(db.services.push(e),s.services++)}),Array.isArray(t.registers)&&(db.registers=t.registers,s.registers=t.registers.length),t.servicesList&&(db.servicesList=t.servicesList),t.customPatientFields&&(db.customPatientFields=t.customPatientFields),t.facility&&(db.facility=t.facility),t.settings&&(db.settings=t.settings),saveDb(),e.querySelector("#shareMsg").innerHTML=`<div class="text-success">\n            Imported: ${s.patients} patients, ${s.visits} visits, ${s.services} services${s.registers?`, ${s.registers} registers`:""}.<br>\n            Registers and facility info updated.\n          </div>`}catch(i){e.querySelector("#shareMsg").innerHTML='<div class="text-danger">Import failed: Invalid or corrupted file.</div>'}},s.readAsText(t)});const l=e.querySelector("#chooseShareBtn"),c=e.querySelector("#shareModal");l&&c&&(l.onclick=()=>{c.className="active";const i=`\n        <label class="form-label mt-3">Select Specific Registers (optional)</label>\n        ${(db.registers||[]).map(e=>`\n          <div class="form-check">\n            <input class="form-check-input" type="checkbox" value="${e.name}" id="reg-${e.name}">\n            <label class="form-check-label" for="reg-${e.name}">${e.name}</label>\n          </div>\n        `).join("")}\n      `;c.innerHTML=`\n        <div class="modal-content mx-auto">\n          <h5>Select Data to Export</h5>\n          <form id="shareForm">\n            <div class="form-check">\n              <input class="form-check-input" type="checkbox" value="patients" id="sharePatients" checked>\n              <label class="form-check-label" for="sharePatients">Patients</label>\n            </div>\n            <div class="form-check">\n              <input class="form-check-input" type="checkbox" value="visits" id="shareVisits" checked>\n              <label class="form-check-label" for="shareVisits">Visits</label>\n            </div>\n            <div class="form-check">\n              <input class="form-check-input" type="checkbox" value="services" id="shareServices" checked>\n              <label class="form-check-label" for="shareServices">Service Entries</label>\n            </div>\n            <div class="form-check">\n              <input class="form-check-input" type="checkbox" value="registers" id="shareRegisters" checked>\n              <label class="form-check-label" for="shareRegisters">Service Registers</label>\n            </div>\n            ${i}\n            <div class="d-flex justify-content-between mt-3">\n              <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-check-circle"></i> Export</button>\n              <button type="button" class="btn btn-secondary btn-sm" id="cancelShare"><i class="bi bi-x-circle"></i> Cancel</button>\n            </div>\n          </form>\n        </div>`,document.getElementById("cancelShare").onclick=()=>{c.className="",c.innerHTML=""},document.getElementById("shareForm").onsubmit=i=>{i.preventDefault();const t={};if(document.getElementById("sharePatients").checked&&(t.patients=db.patients||[]),document.getElementById("shareVisits").checked&&(t.visits=db.visits||[]),document.getElementById("shareServices").checked){const e=Array.from(document.querySelectorAll("input[id^=reg-]:checked")).map(e=>e.value);t.services=e.length?(db.services||[]).filter(i=>e.includes(i.formName)):db.services||[]}document.getElementById("shareRegisters").checked&&(t.registers=db.registers||[]);const s=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),n=URL.createObjectURL(s),a=document.createElement("a");a.href=n,a.download="shared-data.json",document.body.appendChild(a),a.click(),setTimeout(()=>{document.body.removeChild(a),URL.revokeObjectURL(n)},100),e.querySelector("#shareMsg").innerHTML='<div class="text-success">Selected data shared as JSON. Share via USB or SD card.</div>',c.className="",c.innerHTML=""}}),e.querySelectorAll(".service-entry-link").forEach(i=>{i.addEventListener("click",function(i){i.preventDefault();const t=new URL(this.href,window.location.origin).searchParams.get("service");renderServiceVisitSelector(t,{onBack:()=>renderUserDashboard(e)})})});const d=e.querySelector("#appointmentsLink");d&&d.addEventListener("click",function(i){i.preventDefault(),import("./appointments.js").then(i=>{i.renderAppointmentList(e)})})}export function renderImportExportDashboard(e){if(!db.currentUser)return void(window.location.hash="#login");const i=db.facility||{},t=`\n    <div class="facility-meta mb-3">\n      ${i.image?`<img src="${i.image}" alt="Facility Logo" style="max-height:60px; margin-bottom:8px;"><br>`:""}\n      <span class="fw-bold">${i.name||""}</span>\n      <div class="text-muted small">\n        ${[i.region&&`Region: ${i.region}`,i.district&&`District: ${i.district}`,i.community&&`Community: ${i.community}`,i.contact&&`Contact: ${i.contact}`].filter(Boolean).join(" | ")}\n      </div>\n    </div>\n  `;e.innerHTML=`\n    <style>\n      @media (min-width: 768px) {\n        .dashboard-row-equal {\n          display: flex;\n          flex-wrap: wrap;\n        }\n        .dashboard-row-equal > [class^='col-'] {\n          display: flex;\n          flex-direction: column;\n        }\n        .dashboard-row-equal .card {\n          flex: 1 1 auto;\n          height: 100%;\n          min-height: 350px;\n        }\n      }\n      @media (max-width: 767.98px) {\n        .dashboard-row-equal .card {\n          min-height: unset;\n        }\n      }\n    </style>\n    <div class="container my-4">\n      ${t}\n      <div class="row mt-4 g-3 dashboard-row-equal">\n        <div class="col-12 col-md-6 d-flex">\n          <div class="card shadow mb-4 flex-fill">\n            <div class="card-body d-flex flex-column">\n              <h5><i class="bi bi-cloud-arrow-down"></i> Export Data</h5>\n              <div class="list-group mb-3 flex-grow-1">\n                <button class="list-group-item list-group-item-action" id="exportPatients"><i class="bi bi-people me-2"></i> Export Patients</button>\n                <button class="list-group-item list-group-item-action" id="exportVisits"><i class="bi bi-journal-medical me-2"></i> Export Visits</button>\n                <button class="list-group-item list-group-item-action" id="exportServices"><i class="bi bi-ui-checks-grid me-2"></i> Export Services</button>\n              </div>\n            </div>\n          </div>\n        </div>\n        <div class="col-12 col-md-6 d-flex">\n          <div class="card shadow mb-4 flex-fill">\n            <div class="card-body d-flex flex-column">\n              <h5><i class="bi bi-upload"></i> Import Data</h5>\n              <div class="list-group mb-3 flex-grow-1">\n                <label class="list-group-item list-group-item-action" style="cursor:pointer;">\n                  <i class="bi bi-upload me-2"></i> Import Patients\n                  <input type="file" id="importPatients" hidden>\n                </label>\n                <label class="list-group-item list-group-item-action" style="cursor:pointer;">\n                  <i class="bi bi-upload me-2"></i> Import Visits\n                  <input type="file" id="importVisits" hidden>\n                </label>\n                <label class="list-group-item list-group-item-action" style="cursor:pointer;">\n                  <i class="bi bi-upload me-2"></i> Import Services\n                  <input type="file" id="importServices" hidden>\n                </label>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  `,document.getElementById("exportPatients").onclick=()=>exportPatients(),document.getElementById("exportVisits").onclick=()=>exportVisits(),document.getElementById("exportServices").onclick=()=>exportServiceDelivery(),document.getElementById("importPatients").onchange=e=>importPatients(e.target.files[0]),document.getElementById("importVisits").onchange=e=>importVisits(e.target.files[0]),document.getElementById("importServices").onchange=e=>importServices(e.target.files[0])}