import{db,saveDb}from"./db.js";import{generatePatientID}from"./idUtils.js";import{calculateAge,formatDate}from"./utils.js";import{createVisitForm}from"./visits.js";import{renderServiceEntryForm}from"./services.js";import{renderAppointmentForm}from"./appointments.js";const fieldTypes=[{value:"text",label:"Text"},{value:"integer",label:"Integer"},{value:"decimal",label:"Decimal"},{value:"select_one",label:"Single Select (select_one)"},{value:"select_multiple",label:"Multiple Select (select_multiple)"},{value:"date",label:"Date"},{value:"time",label:"Time"},{value:"datetime",label:"DateTime"},{value:"note",label:"Note/Label"},{value:"calculate",label:"Calculation"},{value:"image",label:"Image"},{value:"audio",label:"Audio"},{value:"video",label:"Video"},{value:"file",label:"File Upload"},{value:"barcode",label:"Barcode"},{value:"qr_code",label:"QR Code"},{value:"geopoint",label:"Geopoint"},{value:"geotrace",label:"Geotrace"},{value:"geoshape",label:"Geoshape"}];function showFieldFormPatient(e={name:"",type:"text",required:!1},t=null){const l=document.createElement("div");l.className="modal-overlay",l.innerHTML=`\n    <div class="modal-content mx-auto" style="max-width:400px;">\n      <h6>${null!==t?"Edit Field":"Add Field"}</h6>\n      <form id="fieldForm">\n        <div class="mb-2"><input class="form-control" id="fieldName" placeholder="Field Name" required value="${e.name||""}"></div>\n        <div class="mb-2">\n          <select class="form-select" id="fieldType" required>\n            ${fieldTypes.map(t=>`<option value="${t.value}"${e.type===t.value?" selected":""}>${t.label}</option>`).join("")}\n          </select>\n        </div>\n        <div class="mb-2 form-check">\n          <input class="form-check-input" type="checkbox" id="fieldReq" ${e.required?"checked":""}>\n          <label class="form-check-label" for="fieldReq">Required</label>\n        </div>\n        <div class="mb-2"><input class="form-control" id="fieldDefault" placeholder="Default Value" value="${e.default||""}"></div>\n        <div class="mb-2"><input class="form-control" id="fieldConstraint" placeholder="Constraint/Validation (e.g. min=0,max=100)" value="${e.constraint||""}"></div>\n        <div class="mb-2" id="choicesRow" style="display:${["select_one","select_multiple"].includes(e.type)?"block":"none"}">\n          <input class="form-control" id="fieldChoices" placeholder="Choices (comma-separated, e.g. Yes,No,Unknown)" value="${e.choices||""}" ${["select_one","select_multiple"].includes(e.type)?"required":""}>\n        </div>\n        <div class="mb-2" id="calcRow" style="display:${"calculate"===e.type?"block":"none"}">\n          <input class="form-control" id="fieldCalc" placeholder="Calculation Formula (e.g. today() - dob)" value="${e.calc||""}">\n        </div>\n        <div class="mb-2 d-flex justify-content-between">\n          <button class="btn btn-primary">${null!==t?"Save":"Add"}</button>\n          <button type="button" class="btn btn-secondary" id="cancelFieldBtn">Cancel</button>\n        </div>\n      </form>\n    </div>\n  `,document.body.appendChild(l),l.onclick=e=>{e.target===l&&document.body.removeChild(l)},l.querySelector("#cancelFieldBtn").onclick=()=>document.body.removeChild(l),l.querySelector("#fieldType").onchange=function(){const e=["select_one","select_multiple"].includes(this.value);l.querySelector("#choicesRow").style.display=e?"block":"none",l.querySelector("#fieldChoices").required=e,l.querySelector("#calcRow").style.display="calculate"===this.value?"block":"none"},l.querySelector("#fieldForm").onsubmit=function(e){e.preventDefault();let n={name:this.fieldName.value,type:this.fieldType.value,required:this.fieldReq.checked,default:this.fieldDefault.value,constraint:this.fieldConstraint.value};["select_one","select_multiple"].includes(n.type)&&(n.choices=this.fieldChoices.value),"calculate"===n.type&&(n.calc=this.fieldCalc.value),null!==t?db.customPatientFields[t]=n:db.customPatientFields.push(n),saveDb(),document.body.removeChild(l),"function"==typeof refreshFields&&refreshFields()}}function refresh(e={}){let t=db.patients||[];if(e.id&&(t=t.filter(t=>t.patientID?.includes(e.id))),e.name&&(t=t.filter(t=>t.name?.toLowerCase().includes(e.name.toLowerCase()))),e.phone&&(t=t.filter(t=>t.phone?.includes(e.phone))),document.getElementById("listBody").innerHTML=0===t.length?'<tr><td colspan="9" class="text-center text-muted">No patients found.</td></tr>':t.map((t,l)=>`\n    <tr id="row-${t.patientID}"${e.id&&t.patientID?.toLowerCase().includes(e.id.toLowerCase())?' class="table-info"':""}>\n      <td data-label="ID">${t.patientID||""}</td>\n      <td data-label="Name">${t.name||""}</td>\n      <td data-label="Reg Date">${formatDate(t.registrationDate)||""}</td>\n      <td data-label="DOB">${formatDate(t.dob)||""}</td>\n      <td data-label="Age">${t.age??""}</td>\n      <td data-label="Sex">${t.sex||""}</td>\n      <td data-label="Phone">${t.phone||""}</td>\n      <td data-label="Family">${t.familyId||""}</td>\n      <td data-label="Actions">\n        <button class="btn btn-sm btn-primary me-1" data-i="${l}" data-act="view" title="View/Edit"><i class="bi bi-eye"></i></button>\n        <button class="btn btn-sm btn-danger me-1" data-i="${l}" data-act="del" title="Delete"><i class="bi bi-trash"></i></button>\n        <button class="btn btn-sm btn-outline-success me-1" data-i="${l}" data-act="visit" title="Log Visit"><i class="bi bi-journal-plus"></i></button>\n        <button class="btn btn-sm btn-outline-secondary me-1" data-i="${l}" data-act="service" title="Service Entry"><i class="bi bi-ui-checks-grid"></i></button>\n        <button class="btn btn-sm btn-outline-primary" data-i="${l}" data-act="appoint" title="Book Appointment"><i class="bi bi-calendar-plus"></i></button>\n      </td>\n    </tr>\n    <tr class="visit-form-row d-none" data-form-i="${l}">\n      <td colspan="9"><div class="visit-form-container"></div></td>\n    </tr>`).join(""),e.id){const t=document.getElementById("row-"+e.id);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("table-success"),setTimeout(()=>t.classList.remove("table-success"),2e3))}document.querySelectorAll("[data-act=view]").forEach(e=>e.onclick=()=>showForm(t[e.dataset.i])),document.querySelectorAll("[data-act=del]").forEach(e=>e.onclick=()=>{confirm("Delete this patient?")&&(db.patients.splice(e.dataset.i,1),saveDb(),refresh())}),document.querySelectorAll("[data-act=visit]").forEach(e=>e.onclick=()=>{const l=e.dataset.i,n=t[l],a=document.querySelector(`.visit-form-row[data-form-i="${l}"]`),i=a.querySelector(".visit-form-container"),o=!a.classList.contains("d-none");document.querySelectorAll(".visit-form-row").forEach(e=>e.classList.add("d-none")),o||(i.innerHTML="",i.appendChild(createVisitForm(n,()=>{setTimeout(()=>a.classList.add("d-none"),2e3)})),a.classList.remove("d-none"))}),document.querySelectorAll("[data-act=service]").forEach(e=>e.onclick=()=>{const l=e.dataset.i,n=t[l];renderServiceEntryForm(n,db.registers||[])}),document.querySelectorAll("[data-act=appoint]").forEach(e=>e.onclick=()=>{const l=e.dataset.i,n=t[l];renderAppointmentForm(n)})}function attachFieldHandlers(){document.querySelectorAll(".editFieldBtn").forEach(e=>e.onclick=()=>showFieldFormPatient(db.customPatientFields[e.dataset.fidx],e.dataset.fidx)),document.querySelectorAll(".deleteFieldBtn").forEach(e=>e.onclick=()=>{confirm("Delete this field? Data already captured for this field will be kept in old records.")&&(db.customPatientFields.splice(e.dataset.fidx,1),saveDb(),refreshFields())}),document.querySelectorAll(".moveUpBtn").forEach(e=>e.onclick=()=>{const t=+e.dataset.fidx;t>0&&([db.customPatientFields[t-1],db.customPatientFields[t]]=[db.customPatientFields[t],db.customPatientFields[t-1]],saveDb(),refreshFields())}),document.querySelectorAll(".moveDownBtn").forEach(e=>e.onclick=()=>{const t=+e.dataset.fidx;t<db.customPatientFields.length-1&&([db.customPatientFields[t],db.customPatientFields[t+1]]=[db.customPatientFields[t+1],db.customPatientFields[t]],saveDb(),refreshFields())})}function refreshFields(){document.querySelector("#customFieldList").innerHTML=(db.customPatientFields||[]).map((e,t)=>renderFieldRow(e,t)).join(""),attachFieldHandlers(),(db.customPatientFields||[]).forEach(e=>{if("select_multiple"===e.type){const t=document.querySelectorAll(`input[id^="custom_${e.name}_"]`),l=document.getElementById(`custom_${e.name}`);t.length>0&&l&&t.forEach(e=>{e.addEventListener("change",()=>{const e=Array.from(t).filter(e=>e.checked).map(e=>e.value);l.value=e.join(", ")})})}})}db.customPatientFields||(db.customPatientFields=[]);export function renderPatientList(e){e.innerHTML='\n    <div class="container my-4">\n      <div class="d-flex justify-content-between align-items-center">\n        <h4><i class="bi bi-people"></i> Patients</h4>\n      </div>\n      <div id="formAboveList"></div>\n      \x3c!-- search --\x3e\n      <form id="searchForm" class="row g-2 mb-3">\n        <div class="col-md-2"><input name="id"    class="form-control" placeholder="ID"></div>\n        <div class="col-md-3"><input name="name"  class="form-control" placeholder="Name"></div>\n        <div class="col-md-2"><input name="phone" class="form-control" placeholder="Phone 024-xxx-xxxx"></div>\n        <div class="col-md-2"><button class="btn btn-primary w-100"><i class="bi bi-search"></i> Search</button></div>\n      </form>\n      \x3c!-- list --\x3e\n      <div class="table-responsive">\n        <table class="table table-bordered table-hover align-middle patient-table-mobile">\n          <thead class="table-light">\n            <tr>\n              <th>ID</th><th>Name</th><th>Reg&nbsp;Date</th><th>DOB</th><th>Age</th>\n              <th>Sex</th><th>Phone</th><th>Family</th><th>Actions</th>\n            </tr>\n          </thead>\n          <tbody id="listBody"></tbody>\n        </table>\n      </div>\n      <style>\n      @media (max-width: 768px) {\n        .patient-table-mobile thead { display: none; }\n        .patient-table-mobile tr { display: block; margin-bottom: 1rem; border: 1px solid #dee2e6; border-radius: 8px; }\n        .patient-table-mobile td { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; border: none; border-bottom: 1px solid #eee; }\n        .patient-table-mobile td:last-child { border-bottom: none; }\n        .patient-table-mobile td:before {\n          content: attr(data-label);\n          font-weight: bold;\n          flex: 0 0 40%;\n          color: #555;\n        }\n        .patient-table-mobile td { flex-direction: row; }\n      }\n      </style>\n      <a href="#user-dashboard" class="btn btn-link mt-2"><i class="bi bi-arrow-left"></i> Back to Dashboard</a>\n    </div>\n  ',function(){const e=document.getElementById("formAboveList"),t=(new Date).toISOString().slice(0,10);e.innerHTML=`\n    <div class="card mb-3">\n      <div class="card-body">\n        <h5 class="mb-3"><i class="bi bi-person-plus"></i> New Patient</h5>\n        <form id="pForm">\n          <label class="form-label mb-0">Date of Registration</label>\n          <input  type="date" id="dor" class="form-control mb-2" value="${t}" max="${t}" required>\n          <label class="form-label mb-0">Date of Birth</label>\n          <input  type="date" id="dob" class="form-control" value="" max="${t}">\n          <small id="ageLive" class="text-muted mb-2 d-block"></small>\n          <input  id="name"  class="form-control mb-2" placeholder="Full Name" required value="">\n          <label class="form-label mb-0">Family ID (optional)</label>\n          <input id="familyId" class="form-control mb-2" placeholder="Family ID or Head of Household ID" value="">\n          <select id="sex" class="form-select mb-2" required>\n            <option value="">Sex</option>\n            <option value="M">Male</option>\n            <option value="F">Female</option>\n            <option value="O">Other</option>\n          </select>\n          <input id="phone" class="form-control mb-2" placeholder="Phone 024-xxx-xxxx" value="">\n          <input id="address" class="form-control mb-2" placeholder="Address" value="">\n          <select id="idType" class="form-select mb-2">\n            <option value="">ID Type (optional)</option>\n            <option value="NIN">National ID</option>\n            <option value="DL">Driver's License</option>\n            <option value="VOT">Voter's Card</option>\n          </select>\n          <input id="idNumber" class="form-control mb-3" placeholder="ID Number" value="">\n          ${(db.customPatientFields||[]).map(e=>renderCustomField(e,{})).join("")}\n          <div class="mb-3">\n            <button type="button" class="btn btn-sm btn-success" id="addFieldBtn"><i class="bi bi-plus"></i> Add Field</button>\n            <ul class="list-group mt-2" id="customFieldList" style="z-index:10; position:relative;">\n              ${(db.customPatientFields||[]).map((e,t)=>renderFieldRow(e,t)).join("")}\n            </ul>\n          </div>\n          <div class="d-flex justify-content-between">\n            <button class="btn btn-primary">Add</button>\n          </div>\n        </form>\n      </div>\n    </div>\n  `;const l=document.getElementById("pForm"),n=l.dob,a=l.querySelector("#ageLive"),i=()=>a.textContent=n.value?`Age: ${calculateAge(n.value)}`:"";n.addEventListener("input",i),i(),document.getElementById("addFieldBtn").onclick=e=>{e.preventDefault(),showFieldFormPatient(),setTimeout(()=>{const e=document.querySelector(".modal-overlay .modal-content");e&&e.scrollIntoView({behavior:"smooth",block:"center"})},100)},l.onsubmit=e=>{e.preventDefault();const t={};t.registrationDate=l.dor.value,t.dob=l.dob.value,t.name=l.name.value.trim(),t.familyId=l.familyId.value.trim(),t.sex=l.sex.value,t.phone=l.phone.value.trim(),t.address=l.address.value.trim(),t.idType=l.idType.value,t.idNumber=l.idNumber.value.trim(),t.age=t.dob?calculateAge(t.dob):"",t.patientID=generatePatientID(l.dor.value),t.customFields={},(db.customPatientFields||[]).forEach(e=>{const l=document.getElementById(`custom_${e.name}`);l&&(t.customFields[e.name]=l.value)}),db.patients.push(t),saveDb(),renderPatientList(document.getElementById("app"))},refreshFields()}(),refresh(),function(){const e=document.getElementById("upcomingAppointments");if(!e)return;const t=(new Date).toISOString().slice(0,10),l=(db.appointments||[]).filter(e=>e.appointmentDate===t&&"Scheduled"===e.status).sort((e,t)=>(e.timestamp||0)-(t.timestamp||0)).slice(0,5);if(0===l.length)return void(e.innerHTML='<li class="list-group-item text-muted">No appointments for today.</li>');e.innerHTML=l.map(e=>`\n    <li class="list-group-item d-flex flex-column">\n      <span><i class="bi bi-person"></i> <b>${e.patientName||e.patientID}</b></span>\n      <span class="small text-muted"><i class="bi bi-activity"></i> ${e.serviceType||"-"}</span>\n      <span class="small"><i class="bi bi-clock"></i> ${e.appointmentDate}</span>\n    </li>\n  `).join("")}()}function close(){document.getElementById("modalWrap").className="",document.getElementById("modalWrap").innerHTML=""}function renderCustomField(e,t){const l=t.customFields&&t.customFields[e.name]||"",n=`custom_${e.name}`;switch(e.type){case"text":default:return`<input id="${n}" class="form-control mb-2" placeholder="${e.label||e.name}" value="${l}">`;case"integer":return`<input id="${n}" type="number" step="1" class="form-control mb-2" placeholder="${e.label||e.name}" value="${l}">`;case"decimal":return`<input id="${n}" type="number" step="any" class="form-control mb-2" placeholder="${e.label||e.name}" value="${l}">`;case"date":return`<input id="${n}" type="date" class="form-control mb-2" value="${l}">`;case"select_one":{let t=e.choices;return"string"==typeof t&&(t=t.split(",").map(e=>e.trim()).filter(Boolean)),Array.isArray(t)||(t=[]),`<select id="${n}" class="form-select mb-2"><option value="">${e.label||e.name}</option>`+t.map(e=>`<option value="${e}"${l===e?" selected":""}>${e}</option>`).join("")+"</select>"}case"select_multiple":{let t=e.choices;return"string"==typeof t&&(t=t.split(",").map(e=>e.trim()).filter(Boolean)),Array.isArray(t)||(t=[]),'<div class="mb-2">'+t.map((e,t)=>{const a=l.split(",").map(e=>e.trim()).includes(e)?"checked":"";return`<div class="form-check form-check-inline">\n              <input class="form-check-input" type="checkbox" id="${n}_${t}" value="${e}" ${a}>\n              <label class="form-check-label" for="${n}_${t}">${e}</label>\n            </div>`}).join("")+`<input type="hidden" id="${n}" value="${l}"></div>`}case"note":return`<div class="alert alert-secondary mb-2">${e.label||e.name}</div>`}}function renderFieldRow(e,t){return`<li class="list-group-item d-flex justify-content-between align-items-center">\n      <span><b>${e.label||e.name}</b> <small class="text-muted">(${e.type})</small></span>\n      <span>\n        <button type="button" class="btn btn-sm btn-outline-primary editFieldBtn" data-fidx="${t}"><i class="bi bi-pencil"></i></button>\n        <button type="button" class="btn btn-sm btn-outline-danger deleteFieldBtn" data-fidx="${t}"><i class="bi bi-trash"></i></button>\n        <button type="button" class="btn btn-sm btn-outline-secondary moveUpBtn" data-fidx="${t}"><i class="bi bi-arrow-up"></i></button>\n        <button type="button" class="btn btn-sm btn-outline-secondary moveDownBtn" data-fidx="${t}"><i class="bi bi-arrow-down"></i></button>\n      </span>\n    </li>`}function showForm(e={}){const t=(new Date).toISOString().slice(0,10),l=document.getElementById("modalWrap");l.innerHTML=`\n      <div class="modal-content mx-auto">\n        <h5>${e.patientID?"Edit":"New"} Patient</h5>\n        <form id="pForm" class="mt-2">\n          <label class="form-label mb-0">Date of Registration</label>\n          <input  type="date" id="dor" class="form-control mb-2"\n                  value="${e.registrationDate||t}" max="${t}" required>\n\n          <label class="form-label mb-0">Date of Birth</label>\n          <input  type="date" id="dob" class="form-control" value="${e.dob||""}" max="${t}">\n          <small id="ageLive" class="text-muted mb-2 d-block"></small>\n\n          <input  id="name"  class="form-control mb-2" placeholder="Full Name" required value="${e.name||""}">\n\n          <label class="form-label mb-0">Family ID (optional)</label>\n          <input id="familyId" class="form-control mb-2" placeholder="Family ID or Head of Household ID" value="${e.familyId||""}">\n\n          <select id="sex" class="form-select mb-2" required>\n            <option value="">Sex</option>\n            <option value="M"${"M"===e.sex?" selected":""}>Male</option>\n            <option value="F"${"F"===e.sex?" selected":""}>Female</option>\n            <option value="O"${"O"===e.sex?" selected":""}>Other</option>\n          </select>\n\n          <input id="phone" class="form-control mb-2" placeholder="Phone 024-xxx-xxxx" value="${e.phone||""}">\n          <input id="address" class="form-control mb-2" placeholder="Address" value="${e.address||""}">\n\n          <select id="idType" class="form-select mb-2">\n            <option value="">ID Type (optional)</option>\n            <option value="NIN"${"NIN"===e.idType?" selected":""}>National ID</option>\n            <option value="DL" ${"DL"===e.idType?" selected":""}>Driver's License</option>\n            <option value="VOT"${"VOT"===e.idType?" selected":""}>Voter's Card</option>\n          </select>\n          <input id="idNumber" class="form-control mb-3" placeholder="ID Number" value="${e.idNumber||""}">\n\n          ${(db.customPatientFields||[]).map(t=>renderCustomField(t,e)).join("")}\n\n          <div class="mb-3">\n            <button type="button" class="btn btn-sm btn-success" id="addFieldBtn"><i class="bi bi-plus"></i> Add Custom Field</button>\n            <ul class="list-group mt-2" id="customFieldList">\n              ${(db.customPatientFields||[]).map((e,t)=>renderFieldRow(e,t)).join("")}\n            </ul>\n          </div>\n\n          <div class="d-flex justify-content-between">\n            <button class="btn btn-primary">${e.patientID?"Save":"Add"}</button>\n            <button type="button" class="btn btn-secondary" id="cancelF">Cancel</button>\n          </div>\n        </form>\n      </div>`,l.className="active",l.onclick=e=>{e.target===l&&close()},document.getElementById("cancelF").onclick=close;const n=document.getElementById("pForm"),a=n.dob,i=n.querySelector("#ageLive"),o=()=>i.textContent=a.value?`Age: ${calculateAge(a.value)}`:"";a.addEventListener("input",o),o(),db.customPatientFields||(db.customPatientFields=[]),document.getElementById("addFieldBtn").onclick=()=>showFieldFormPatient(),n.onsubmit=t=>{t.preventDefault();const l=(new Date).toISOString().slice(0,10);if(n.dor.value>l)return void alert("Registration date cannot be in the future.");if(n.dob.value&&n.dob.value>l)return void alert("Date of birth cannot be in the future.");const a=e.patientID?e:{};if(a.registrationDate=n.dor.value,a.dob=n.dob.value,a.name=n.name.value.trim(),a.familyId=n.familyId.value.trim(),a.sex=n.sex.value,a.phone=n.phone.value.trim(),a.address=n.address.value.trim(),a.idType=n.idType.value,a.idNumber=n.idNumber.value.trim(),a.age=a.dob?calculateAge(a.dob):"",a.customFields=a.customFields||{},(db.customPatientFields||[]).forEach(e=>{const t=document.getElementById(`custom_${e.name}`);t&&(a.customFields[e.name]=t.value)}),a.patientID||(a.patientID=generatePatientID()),e.patientID){const e=db.patients.findIndex(e=>e.patientID===a.patientID);-1!==e&&(db.patients[e]=a)}else db.patients.push(a);saveDb(),close(),"function"==typeof refresh&&refresh()},"function"==typeof attachFieldHandlers&&attachFieldHandlers()}window.showFieldFormPatient=function(e={name:"",type:"text",required:!1},t=null){const l=document.createElement("div");l.className="modal-overlay",l.innerHTML=`\n      <div class="modal-content mx-auto" style="max-width:400px;">\n        <h6>${null!==t?"Edit Field":"Add Field"}</h6>\n        <form id="fieldForm">\n          <div class="mb-2"><input class="form-control" id="fieldName" placeholder="Field Name" required value="${e.name||""}"></div>\n          <div class="mb-2">\n            <select class="form-select" id="fieldType" required>\n              ${fieldTypes.map(t=>`<option value="${t.value}"${e.type===t.value?" selected":""}>${t.label}</option>`).join("")}\n            </select>\n          </div>\n          <div class="mb-2 form-check">\n            <input class="form-check-input" type="checkbox" id="fieldReq" ${e.required?"checked":""}>\n            <label class="form-check-label" for="fieldReq">Required</label>\n          </div>\n          <div class="mb-2"><input class="form-control" id="fieldDefault" placeholder="Default Value" value="${e.default||""}"></div>\n          <div class="mb-2"><input class="form-control" id="fieldConstraint" placeholder="Constraint/Validation (e.g. min=0,max=100)" value="${e.constraint||""}"></div>\n          <div class="mb-2" id="choicesRow" style="display:${["select_one","select_multiple"].includes(e.type)?"block":"none"}">\n            <input class="form-control" id="fieldChoices" placeholder="Choices (comma-separated, e.g. Yes,No,Unknown)" value="${e.choices||""}" ${["select_one","select_multiple"].includes(e.type)?"required":""}>\n          </div>\n          <div class="mb-2" id="calcRow" style="display:${"calculate"===e.type?"block":"none"}">\n            <input class="form-control" id="fieldCalc" placeholder="Calculation Formula (e.g. today() - dob)" value="${e.calc||""}">\n          </div>\n          <div class="mb-2 d-flex justify-content-between">\n            <button class="btn btn-primary">${null!==t?"Save":"Add"}</button>\n            <button type="button" class="btn btn-secondary" id="cancelFieldBtn">Cancel</button>\n          </div>\n        </form>\n      </div>\n    `,document.body.appendChild(l),l.onclick=e=>{e.target===l&&document.body.removeChild(l)},l.querySelector("#cancelFieldBtn").onclick=()=>document.body.removeChild(l),l.querySelector("#fieldType").onchange=function(){const e=["select_one","select_multiple"].includes(this.value);l.querySelector("#choicesRow").style.display=e?"block":"none",l.querySelector("#fieldChoices").required=e,l.querySelector("#calcRow").style.display="calculate"===this.value?"block":"none"},l.querySelector("#fieldForm").onsubmit=function(e){e.preventDefault();let n={name:this.fieldName.value,type:this.fieldType.value,required:this.fieldReq.checked,default:this.fieldDefault.value,constraint:this.fieldConstraint.value};["select_one","select_multiple"].includes(n.type)&&(n.choices=this.fieldChoices.value),"calculate"===n.type&&(n.calc=this.fieldCalc.value),null!==t?db.customPatientFields[t]=n:db.customPatientFields.push(n),saveDb(),document.body.removeChild(l),"function"==typeof refreshFields&&refreshFields()}};export{showForm as showPatientRegistrationModal};